<!DOCTYPE html>

<html lang="ja">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>住宅ローン繰上げ返済・簡易計算フォーム（修正版・正確計算）</title>
<style>
  :root { --bg:#0f172a; --fg:#e2e8f0; --muted:#94a3b8; --card:#111827; --accent:#38bdf8; --ok:#34d399; --warn:#fbbf24; }
  *{box-sizing:border-box}
  body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; background:var(--bg); color:var(--fg)}
  header{padding:20px; text-align:center}
  .container{max-width:1100px; margin:0 auto; padding:16px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media (max-width: 900px){ .grid{ grid-template-columns:1fr } }
  .card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px}
  h1{font-size:1.35rem; margin:0 0 6px}
  h2{font-size:1.05rem; margin:16px 0 8px; color:var(--muted)}
  label{display:block; font-size:.9rem; color:var(--muted); margin-bottom:6px}
  input[type=number]{width:100%; padding:10px 12px; background:#0b1020; color:var(--fg); border:1px solid #293246; border-radius:10px; outline:none}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .help{font-size:.8rem; color:var(--muted)}
  .btn{cursor:pointer; padding:12px 16px; border-radius:10px; border:1px solid #1f2937; background:#0b1020; color:var(--fg); font-weight:600}
  .btn:hover{border-color:var(--accent)}
  .accent{color:#001018; background:var(--accent); border:none}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:.75rem; border:1px solid #1f2937}
  .warn{background:rgba(251,191,36,.15); color:#fde68a}
  .results{display:grid; grid-template-columns: repeat(2, 1fr); gap:12px}
  @media (max-width: 900px){ .results{ grid-template-columns:1fr } }
  .kpi{background:#0b1020; border:1px solid #1f2937; border-radius:12px; padding:12px}
  .kpi h3{margin:0; font-size:.95rem; color:var(--muted)}
  .kpi .val{font-size:1.35rem; font-weight:800; margin-top:6px}
  .small{font-size:.8rem; color:var(--muted)}
  footer{text-align:center; padding:16px; color:var(--muted); font-size:.8rem}
  .mode{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .mode label.inline{display:flex; align-items:center; gap:6px; cursor:pointer; color:var(--fg)}
  .hr{height:1px; background:#1f2937; margin:12px 0}
  .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  details{background:#0b1020; border:1px solid #1f2937; border-radius:12px; padding:10px 12px}
  summary{cursor:pointer; font-weight:700}
  table{width:100%; border-collapse: collapse}
  th, td{padding:6px 8px; border-bottom:1px solid #1f2937; text-align:right}
  th:first-child, td:first-child, th:nth-child(2), td:nth-child(2){text-align:left}

/* === Mobile Enhancements === */
:root {
  --touch: 48px;
}

body { font-size: 16px; line-height: 1.6; }

/* Stack layout for small screens */
@media (max-width: 640px) {
  .container { padding: 12px; }
  h1 { font-size: 1.1rem; line-height: 1.3; }
  h2 { font-size: 1rem; }
  .card { padding: 12px; border-radius: 14px; }
  .results { display: grid; grid-template-columns: 1fr; gap: 8px; }
  .kpi .val { font-size: 1.1rem; }
  .kpi { padding: 10px; }
  label { font-size: .9rem; }
  input[type=number] { font-size: 16px; padding: 12px; height: var(--touch); }
  input[type=checkbox] { width: 20px; height: 20px; }
  .btn, .btn.accent { width: 100%; min-height: var(--touch); border-radius: 12px; padding: 14px 16px; }
  .controls { display: grid; grid-template-columns: 1fr; gap: 10px; }
  .controls .row { display: grid; grid-template-columns: 1fr; gap: 8px; }
  .help, .small { font-size: .85rem; }
  table { font-size: .9rem; }
  th, td { padding: 8px; }
  .hr { margin: 10px 0; }
}

/* Make tables scrollable horizontally */
table { width: 100%; border-collapse: collapse; }
table thead th { position: sticky; top: 0; background: #0b1020; }
table tr:nth-child(odd) { background: rgba(255,255,255,0.02); }
table tr:nth-child(even) { background: rgba(255,255,255,0.04); }
#investTable, #previewTable { display:block; overflow-x:auto; }

/* Bigger touch targets for selects etc (future-proofing) */
select { min-height: var(--touch); font-size: 16px; }


/* iOS tap highlight */
* { -webkit-tap-highlight-color: rgba(56,189,248,.25); }


/* === Mobile card layout for Investment table (no horizontal swipe) === */
@media (max-width: 640px) {
  #investTable thead { display: none; }
  #investTable tbody { display: block; }
  #investTable tr {
    display: block;
    background: #0b1020;
    border: 1px solid #1f2937;
    border-radius: 12px;
    padding: 10px 12px;
    margin-bottom: 12px;
  }
  #investTable td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    width: 100%;
    box-sizing: border-box;
  }
  #investTable td::before {
    content: attr(data-label);
    color: var(--muted);
    font-size: .85rem;
    margin-right: 12px;
  }
  .results .kpi .val { word-break: break-all; }
}

</style>
</head>
<body>
<header>
<h1>住宅ローン繰上げ返済・簡易計算フォーム（修正版・正確計算）  (v12 mobile v3)</h1>
<div class="help">元利均等返済を正しく再スケジュール。<strong>期間短縮型／返済額軽減型</strong>に対応。</div>
</header>
<div class="container">
<div class="grid">
<section class="card">
<h2>入力</h2>
<div class="row">
<div class="row"><div>
<label>借入残高（万円）</label>
<input id="principal" min="0" placeholder="例: 5000 (＝5000万円)" step="10000" type="number"/>
</div></div>
<div class="row"><div>
<label>年利（％）</label>
<input id="annualRate" min="0" placeholder="例: 1.0 (％)" step="0.01" type="number"/>
</div></div>
</div>
<div class="row">
<div class="row"><div>
<label>残存期間（年）</label>
<input id="years" min="0" placeholder="例: 25 (年)" step="1" type="number"/>
</div></div>
<div class="row"><div>
<label>事務手数料（円）</label>
<input id="fee" min="0" placeholder="例: 10000 (円)" step="1000" type="number"/>
</div></div>
</div>
<div class="row">
<div class="row"><div>
<label>繰上げ返済額（万円）</label>
<input id="prepay" min="0" placeholder="例: 100 (＝100万円)" step="10000" type="number"/>
</div></div>
<div>
<label>実行タイミング（月）</label>
<input id="prepayMonth" min="1" placeholder="例: 1 (＝今月)" step="1" type="number" value="1"/>
<div class="help">（1=今月。2=来月…）</div>
</div>
</div>
<div class="hr"></div>
<div class="mode">
<div class="hr"></div>
<div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
<label class="inline">
<input id="useManualPay" type="checkbox"/> 毎月返済額を手入力する
    </label>
<div style="min-width:280px;">
<label>実際の毎月返済額（円）</label>
<input id="manualPay" min="0" placeholder="例: 179548" step="100" type="number"/>
<div class="help">例：179548 など（ベースの毎月返済額として使用）</div>
</div>
</div>
<div class="hr"></div>
<label class="inline"><input checked="" name="mode" type="radio" value="shorten"/> 期間短縮型</label>
<label class="inline"><input name="mode" type="radio" value="reduce"/> 返済額軽減型</label>
</div>
<div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
<button class="btn accent" style="display:block; margin-top:8px;" id="calcBtn" type="button" onclick="render()" type="button">計算する</button>
<button class="btn" style="display:block; margin-top:8px;" id="exampleBtn" type="button" onclick="fillExample()" type="button">例（5000万 / 1.0％ / 25年 / 繰上げ100万 / 今月）</button>
<span class="pill warn">注意：概算。最終確認は金融機関の試算で。</span>
</div>
</section>
<section class="card">
<h2>結果（概算）</h2>
<div class="results">
<div class="kpi">
<h3>毎月返済額（繰上げ前）</h3>
<div class="val mono" id="kpiMonthly">-</div>
<div class="small">元利均等</div>
</div>
<div class="kpi">
<h3>総返済額（繰上げ前）</h3>
<div class="val mono" id="kpiTotalBefore">-</div>
<div class="small">完済までの合計</div>
</div>
<div class="kpi">
<h3>総返済額（繰上げ後）</h3>
<div class="val mono" id="kpiTotalAfter">-</div>
<div class="small" id="kpiAfterNote">方式により異なる</div>
</div>
<div class="kpi">
<h3>利息削減額（手数料考慮後）</h3>
<div class="val mono" id="kpiSavings">-</div>
<div class="small">（利息削減 − 手数料）</div>
</div>
<div class="kpi">
<h3>短縮期間 / 返済額減</h3>
<div class="val mono" id="kpiDelta">-</div>
<div class="small" id="kpiDeltaNote">期間短縮＝短縮月数／軽減＝毎月の減額</div>
</div>
<div class="kpi">
<h3>推奨度</h3>
<div class="val" id="kpiRating">-</div>
<div class="small">判定基準：手数料後の利得÷繰上げ額（概算ROI）</div>
<div style="margin-top:6px; display:flex; align-items:center; gap:8px;">
<label class="small" for="ratingBuffer" style="min-width:140px;">推奨バッファ（%）</label>
<input id="ratingBuffer" min="0" step="1" style="width:90px; padding:6px 8px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; border-radius:10px;" type="number" value="10"/>
<span class="small">例：10%なら ROI≧10% の時のみ「推奨」</span>
</div>
</div>
</div>
</section>
</div>
<section class="card" style="margin-top:16px;">
<h2>明細（先頭12ヶ月のみ表示）</h2>
<details>
<summary>繰上げ前／後の比較テーブルを開く</summary>
<div id="tableWrap" style="overflow:auto; margin-top:10px;"></div>
</details>
</section>
<section class="card" style="margin-top:16px;">
<h2>投資 vs. 繰上げ シミュレーター</h2>
<div class="help">投資資金＝上部の繰上げ返済額と同額。年率は幾何平均の想定。投資期間は<strong>残存期間</strong>ベース。</div>
<div class="hr"></div>
<div class="kpi" id="investSummary" style="margin-bottom:12px;">
<h3>判定</h3>
<div class="val" id="investDecision">-</div>
<div class="small">ルール：投資の期待利益 vs. 利息削減（手数料控除後）</div>
</div>
<div style="margin:8px 0 4px 0; display:flex; align-items:center; gap:8px;">
<label class="small" for="decisionBuffer" style="min-width:140px;">判定バッファ（%）</label>
<input id="decisionBuffer" min="0" step="1" style="width:90px; padding:6px 8px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; border-radius:10px;" type="number" value="10"/>
<span class="small">例：10%なら、期待利益が利息削減を10%以上上回る場合だけ「投資優位」</span>
</div>
<div class="results">
<div class="kpi">
<h3>比較ベース</h3>
<div class="val mono" id="cmpBase">-</div>
<div class="small">利息削減（手数料後）</div>
</div>
<div class="kpi">
<h3>投資期間（年）</h3>
<div class="val mono" id="horizonYears">-</div>
<div class="small">残存期間を基準に算定（判定バッファ適用）</div>
</div>
</div>
<div style="overflow:auto; margin-top:12px;">
<table id="investTable">
<thead>
<tr>
<th style="text-align:left">想定年率</th>
<th>元本（＝繰上げ額）</th>
<th>将来価値</th>
<th>期待利益</th>
<th style="text-align:left">判定</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="small" style="margin-top:8px;">
        注：判定は単純比較（割引現在価値は未考慮）。必要ならNPV比較へ拡張可。
      </div>
<div class="kpi" style="margin-top:12px;">
<h3>境界利回り（ブレークイーブン）</h3>
<div class="val mono" id="breakevenRate">-</div>
<div class="small">この年率を超えると投資優位（概算）</div>
</div>
</section>
<section class="card" style="margin-top:16px;">
<h2>前提</h2>
<ul>
<li>元利均等返済。月利 = 年利/12。</li>
<li>指定月の返済後に繰上げを反映する近似。</li>
<li>期間短縮型：毎月返済額は不変、完済を前倒し。</li>
<li>返済額軽減型：完済時期は不変、繰上げ後の毎月返済額を再計算。</li>
<li>表示の「総返済額（繰上げ後）」には繰上げ元金を含めます。利息計算の比較では繰上げ元金は除外します。</li>
</ul>
</section>
</div>
<footer>© 簡易ツール（参考用）</footer>
<script>
function fmtYen(n){ return '¥' + (isFinite(n) ? Math.round(n).toLocaleString('ja-JP') : '-'); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

function monthlyPayment(P, r_m, n){
  if (n <= 0) return 0;
  if (r_m === 0) return P / n;
  const f = Math.pow(1 + r_m, -n);
  return P * r_m / (1 - f);
}

function amortize(P, r_m, n, pay){
  const out = [];
  let bal = P;
  for (let m=1; m<=n; m++){
    const interest = bal * r_m;
    let principal = pay - interest;
    if (principal > bal) principal = bal;
    const payment = interest + principal;
    bal = Math.max(0, bal - principal);
    out.push({month:m, payment, interest, principal, balance:bal});
    if (bal <= 0) break;
  }
  return out;
}

function simulate(params){
  const P = Math.max(0, Number(params.principal)||0) * 10000;
  const annual = Math.max(0, Number(params.annualRate)||0) / 100;
  const n = Math.max(0, Math.round(Number(params.years)||0) * 12);
  const fee = Math.max(0, Number(params.fee)||0);
  const prepay = Math.max(0, Number(params.prepay)||0) * 10000;
  const prepayMonth = clamp(Math.round(Number(params.prepayMonth)||1), 1, n);
  const mode = params.mode;
  const r_m = annual / 12;

  // Baseline
  let pay0 = monthlyPayment(P, r_m, n);
  if (params.useManual){
    const mp = Math.max(0, Number(params.manualPay)||0);
    const minNeeded = P * r_m + 1;
    if (mp >= minNeeded){ pay0 = mp; }
  }
  const base = amortize(P, r_m, n, pay0);
  const total0 = base.reduce((s,x)=>s+x.payment,0);
  const interest0 = base.reduce((s,x)=>s+x.interest,0);

  // Up to prepayment month
  const upTo = amortize(P, r_m, n, pay0).slice(0, prepayMonth);
  let balAt = upTo.length ? upTo[upTo.length-1].balance : P;
  let paidToDate = upTo.reduce((s,x)=>s+x.payment,0);

  // Apply prepayment
  const prepayEff = Math.min(prepay, balAt);
  balAt -= prepayEff;

  let afterSched = [];
  let totalAfter = paidToDate + prepayEff;
  let payAfter = pay0;

  if (mode === 'shorten'){
    if (balAt > 0){
      afterSched = amortize(balAt, r_m, n - prepayMonth, pay0);
    }
  } else {
    const remainingTerm = Math.max(0, n - prepayMonth);
    payAfter = monthlyPayment(balAt, r_m, remainingTerm);
    if (balAt > 0 && remainingTerm > 0){
      afterSched = amortize(balAt, r_m, remainingTerm, payAfter);
    }
  }

  totalAfter += afterSched.reduce((s,x)=>s+x.payment,0);
  const interestAfter = (totalAfter - prepayEff) - P;

  const interestSaved = Math.max(0, interest0 - interestAfter);
  const netBenefit = Math.max(0, interestSaved - fee);

  const monthsShort = (mode==='shorten') ? (base.length - (upTo.length + afterSched.length)) : 0;
  const payCut = (mode==='reduce') ? (pay0 - payAfter) : 0;

  // preview table (first 12 months)
  const rows = [];
  const maxRows = 12;
  for (let i=0; i<maxRows; i++){
    const b = base[i] || {month:i+1,payment:0,interest:0,principal:0,balance:0};
    let a;
    if (i < upTo.length){
      a = upTo[i];
    } else if (i === upTo.length){
      a = {
        month: i+1,
        payment: (upTo[i]?.payment || 0) + prepayEff,
        interest: upTo[i]?.interest || 0,
        principal: (upTo[i]?.principal || 0) + prepayEff,
        balance: balAt
      };
    } else {
      const j = i - upTo.length - 1;
      a = afterSched[j] || {month:i+1,payment:0,interest:0,principal:0,balance:0};
    }
    rows.push({b,a});
  }

  return { pay0, total0, totalAfter, interestSaved, netBenefit, monthsShort, payCut, payAfter, upTo, afterSched, prepayEff, rows };
}


function investVsPrepay(prepayEff, netBenefit, monthsRemaining){
  const years = Math.max(0, monthsRemaining) / 12;
  const rates = [0.01, 0.03, 0.05, 0.07];
  let bufPct = 0;
  const bufEl = document.getElementById('decisionBuffer');
  if (bufEl){ const v = Number(bufEl.value); bufPct = isFinite(v)&&v>=0? v:0; }
  const buf = 1 + (bufPct/100);
  const rows = rates.map(r=>{
    const FV = prepayEff * Math.pow(1+r, years);
    const gain = FV - prepayEff;
    let decision = '拮抗';
    if (gain > netBenefit * buf) decision = '投資優位';
    else if (netBenefit > gain * buf) decision = '繰上げ優位';
    return {r, FV, gain, decision};
  });
  let breakeven = null;
  if (prepayEff > 0 && netBenefit > 0 && years > 0){
    breakeven = Math.pow(1 + (netBenefit / prepayEff), 1/years) - 1;
  }
  return {years, rows, breakeven, bufPct};
}


function fillExample(){
  const $ = (id)=>document.getElementById(id);
  const parseFromPH = (id) => {
    const el = $(id);
    if (!el) return null;
    const ph = el.getAttribute('placeholder') || '';
    const m = ph.match(/([-+]?\d*\.?\d+)/);
    if (!m) return null;
    const num = Number(m[1]);
    return isFinite(num) ? num : null;
  };
  const setIf = (id, val)=>{ const el=$(id); if (el && val!=null){ el.value = val; } };

  setIf('principal',   parseFromPH('principal'));
  setIf('annualRate',  parseFromPH('annualRate'));
  setIf('years',       parseFromPH('years'));
  setIf('fee',         parseFromPH('fee'));
  setIf('prepay',      parseFromPH('prepay'));
  setIf('prepayMonth', parseFromPH('prepayMonth'));
  setIf('manualPay',   parseFromPH('manualPay'));

  if (typeof render === 'function') render();
}
function render(){
  const params = {
    principal: document.getElementById('principal').value,
    annualRate: document.getElementById('annualRate').value,
    years: document.getElementById('years').value,
    fee: document.getElementById('fee').value,
    prepay: document.getElementById('prepay').value,
    prepayMonth: document.getElementById('prepayMonth').value,
    mode: document.querySelector('input[name="mode"]:checked').value,
    useManual: document.getElementById('useManualPay').checked,
    manualPay: document.getElementById('manualPay').value
  };
  const r = simulate(params);
  
  // --- Investment vs Prepayment (lower section) ---
  const monthsRemaining = Math.max(0, Math.round(Number(params.years)||0)*12 - Math.round(Number(params.prepayMonth)||1) + 1);
  const cmp = investVsPrepay(r.prepayEff, r.netBenefit, monthsRemaining);

  const cmpBaseEl = document.getElementById('cmpBase');
  const horizonEl = document.getElementById('horizonYears');
  const decisionEl = document.getElementById('investDecision');
  const tblBody = document.querySelector('#investTable tbody');
  const brkEl = document.getElementById('breakevenRate');

  if (cmpBaseEl && horizonEl && decisionEl && tblBody){
    cmpBaseEl.textContent = fmtYen(r.netBenefit);
    horizonEl.textContent = (Math.round(cmp.years*100)/100).toString();
    const votes = cmp.rows.map(x=>x.decision);
    const investCount = votes.filter(v=>v==='投資優位').length;
    const prepayCount = votes.filter(v=>v==='繰上げ優位').length;
    let overall = '条件次第（拮抗）';
    if (investCount >= 3) overall = '投資優位（総合）';
    else if (prepayCount >= 3) overall = '繰上げ優位（総合）';
    decisionEl.textContent = overall;

    tblBody.innerHTML = cmp.rows.map(x=>{
      const rateStr = (Math.round(x.r*10000)/100).toFixed(2) + '%';
      return `<tr>
        <td data-label="想定年率" style="text-align:left">${rateStr}</td>
        <td data-label="元本（＝繰上げ額）" class="mono">${fmtYen(r.prepayEff)}</td>
        <td data-label="将来価値" class="mono">${fmtYen(x.FV)}</td>
        <td data-label="期待利益" class="mono">${fmtYen(x.gain)}</td>
        <td data-label="判定" style="text-align:left">${x.decision}</td>
      </tr>`;
    }).join('');

    if (brkEl){
      brkEl.textContent = (cmp.breakeven!=null) ? ((Math.round(cmp.breakeven*10000)/100).toFixed(2) + '%') : '-';
    }
  }

  // --- Upper "推奨度" stricter logic ---
  (function(){
    const prepayEff = r.prepayEff;               // 繰上げ額（手数料控除後）
    const benefit  = r.netBenefit;               // 利息削減（手数料後）
    const roi = (prepayEff > 0) ? (benefit / prepayEff) : 0; // 概算ROI
    const bufEl = document.getElementById('ratingBuffer');
    let bufPct = 10;
    if (bufEl){ const v = Number(bufEl.value); bufPct = isFinite(v)&&v>=0? v:10; }
    const th  = bufPct/100;                      // 推奨閾値
    const mid = Math.max(0, th*0.5);             // 中立域の下限

    let rating = '中立';
    if (roi >= th) rating = '推奨';
    else if (roi < mid) rating = '非推奨';

    const el = document.getElementById('kpiRating');
    if (el){
      el.textContent = rating;
      el.title = `ROI=${(roi*100).toFixed(2)}%, 閾値=${bufPct}%`;
    }
  })();
document.getElementById('kpiMonthly').textContent = fmtYen(r.pay0);
  document.getElementById('kpiTotalBefore').textContent = fmtYen(r.total0);
  document.getElementById('kpiTotalAfter').textContent = fmtYen(r.totalAfter);
  document.getElementById('kpiAfterNote').textContent = (params.mode==='shorten') ? '期間短縮型（毎月額そのまま）' : '返済額軽減型（毎月額を再計算）';
  if (params.useManual){ document.getElementById('kpiAfterNote').textContent += ' ／ ベース毎月額＝手入力'; }
  document.getElementById('kpiSavings').textContent = fmtYen(r.netBenefit);

  if (params.mode==='shorten'){
    document.getElementById('kpiDelta').textContent = r.monthsShort + ' ヵ月 短縮';
    document.getElementById('kpiDeltaNote').textContent = '完済が前倒しになります';
  } else {
    document.getElementById('kpiDelta').textContent = fmtYen(r.payCut) + ' /月 減額';
    document.getElementById('kpiDeltaNote').textContent = '毎月返済額の減少幅（概算）';
  }

  // ★ 推奨度（◎／○／△／×）表示：ROI=手数料後の利得÷繰上げ額 を基準に判定
  let rating = '×（実行非推奨）';
  const roi = (r.prepayEff > 0) ? (r.netBenefit / r.prepayEff) : 0; // 概算ROI（生涯）
  if (r.netBenefit > 0){
    if (roi >= 0.15) rating = '◎（実行強く推奨）';
    else if (roi >= 0.05) rating = '○（推奨）';
    else rating = '△（効果限定的）';
  }
  document.getElementById('kpiRating').textContent = rating;

  const tableWrap = document.getElementById('tableWrap');
  const html = r.rows.map((row, idx)=>{
    const m = idx+1;
    const b = row.b, a = row.a;
    return `<tr>
      <td>${m}</td><td>繰上げ前</td>
      <td class="mono">${fmtYen(b.payment)}</td>
      <td class="mono">${fmtYen(b.interest)}</td>
      <td class="mono">${fmtYen(b.principal)}</td>
      <td class="mono">${fmtYen(b.balance)}</td>
    </tr>
    <tr>
      <td>${m}</td><td>繰上げ後</td>
      <td class="mono">${fmtYen(a.payment)}</td>
      <td class="mono">${fmtYen(a.interest)}</td>
      <td class="mono">${fmtYen(a.principal)}</td>
      <td class="mono">${fmtYen(a.balance)}</td>
    </tr>`;
  }).join('');

  tableWrap.innerHTML = `<table>
    <thead><tr><th>月</th><th>シナリオ</th><th>返済額</th><th>利息</th><th>元金</th><th>残高</th></tr></thead>
    <tbody>${html}</tbody>
  </table>`;
}

document.getElementById('calcBtn').addEventListener('click', render);
document.getElementById('exampleBtn').addEventListener('click', ()=>{
  document.getElementById('principal').value = 5000;
  document.getElementById('annualRate').value = 1.0;
  document.getElementById('years').value = 25;
  document.getElementById('fee').value = 10000;
  document.getElementById('prepay').value = 100;
  document.getElementById('prepayMonth').value = 1;
  document.getElementById('useManualPay').checked = false;
  document.getElementById('manualPay').value = "";
  document.querySelector('input[name="mode"][value="shorten"]').checked = true;
  render();
});

// initial render
render();

</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    const calcBtn = document.getElementById('calcBtn');
    if (calcBtn){
      // Remove existing click listeners if any by cloning (safe reset), then rebind
      const clone = calcBtn.cloneNode(true);
      calcBtn.parentNode.replaceChild(clone, calcBtn);
      clone.addEventListener('click', function(e){
        e.preventDefault();
        if (typeof render === 'function') render();
      });
    }
    const exampleBtn = document.getElementById('exampleBtn');
    if (exampleBtn){
      const exClone = exampleBtn.cloneNode(true);
      exampleBtn.parentNode.replaceChild(exClone, exampleBtn);
      exClone.addEventListener('click', function(e){
        e.preventDefault();
        if (typeof fillExample === 'function') fillExample();
        if (typeof render === 'function') render();
      });
    }
  } catch(err){
    console.error('Init error:', err);
  }
});
</script>
</body>
</html>