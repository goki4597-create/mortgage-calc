<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Mortgage Prepayment Calculator (Mobile)</title>
<meta name="theme-color" content="#0f172a">
<style>
  :root{
    color-scheme: light dark;
    --bg:#0f172a; --fg:#e2e8f0; --muted:#94a3b8; --card:#111827; --accent:#38bdf8; --ok:#34d399; --warn:#fbbf24; --danger:#ef4444;
    --ring:#1f2937;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html,body{height:100%}
  body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
       background:var(--bg); color:var(--fg); line-height:1.6;}
  header{position:sticky; top:0; z-index:5; backdrop-filter:saturate(1.2) blur(6px);
         background:color-mix(in hsl, var(--bg) 80%, transparent); border-bottom:1px solid var(--ring); padding:12px 16px}
  h1{font-size:1.05rem; margin:0}
  .container{max-width:900px; margin:0 auto; padding:12px 12px 96px}
  .card{background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:12px; margin:12px 0}
  .grid{display:grid; gap:10px}
  @media(min-width:720px){ .grid.cols2{ grid-template-columns:1fr 1fr } }
  label{display:block; font-size:.9rem; color:var(--muted); margin:6px 2px}
  input[type=number], input[type=text]{width:100%; height:44px; padding:10px 12px; border-radius:12px; border:1px solid var(--ring);
                                       background:#0b1020; color:var(--fg); font-size:16px; outline:none}
  input:focus{box-shadow:0 0 0 3px color-mix(in hsl, var(--accent), transparent 70%); border-color: var(--accent)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .btn{height:44px; padding:0 16px; border-radius:12px; border:1px solid var(--ring); background:#0b1020; color:var(--fg);
       font-weight:700; letter-spacing:.3px}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent); color:#001018; border:none}
  .muted{color:var(--muted); font-size:.85rem}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--ring); font-size:.75rem}
  .kpis{display:grid; gap:10px}
  @media(min-width:720px){ .kpis{ grid-template-columns:repeat(3,1fr) } }
  .kpi{background:#0b1020; border:1px solid var(--ring); border-radius:12px; padding:10px}
  .kpi h3{margin:0; font-size:.9rem; color:var(--muted)}
  .kpi .val{font-variant-numeric: tabular-nums; font-size:1.35rem; font-weight:800; margin-top:4px}
  .sticky-cta{position:fixed; left:0; right:0; bottom:0; padding:10px 12px; backdrop-filter: blur(8px);
              background:color-mix(in hsl, var(--bg) 75%, transparent); border-top:1px solid var(--ring);}
  table{width:100%; border-collapse:collapse; font-size:.9rem}
  th,td{padding:6px 8px; border-bottom:1px solid var(--ring); text-align:right}
  th:first-child, td:first-child, th:nth-child(2), td:nth-child(2){text-align:left}
  details{background:#0b1020; border:1px solid var(--ring); border-radius:12px; padding:8px 10px}
  summary{cursor:pointer; font-weight:700}
  .rating{font-weight:900}
</style>
</head>
<body>
  <header>
    <h1>住宅ローン繰上げ返済・スマホ最適化版</h1>
    <div class="muted">方式：期間短縮／返済額軽減。推奨度＝◎○△×</div>
  </header>

  <div class="container">
    <section class="card">
      <div class="grid cols2">
        <div>
          <label>借入残高（万円）</label>
          <input type="number" id="principal" inputmode="numeric" pattern="[0-9]*" placeholder="例: 3000" enterkeyhint="done" min="0" step="1">
        </div>
        <div>
          <label>年利（％）</label>
          <input type="number" id="annualRate" inputmode="decimal" placeholder="例: 1.0" min="0" step="0.01">
        </div>
        <div>
          <label>残存期間（年）</label>
          <input type="number" id="years" inputmode="numeric" pattern="[0-9]*" placeholder="例: 15" min="0" step="1">
        </div>
        <div>
          <label>事務手数料（円）</label>
          <input type="number" id="fee" inputmode="numeric" pattern="[0-9]*" placeholder="例: 10000" min="0" step="100">
        </div>
        <div>
          <label>繰上げ返済額（万円）</label>
          <input type="number" id="prepay" inputmode="numeric" pattern="[0-9]*" placeholder="例: 100" min="0" step="1">
        </div>
        <div>
          <label>実行タイミング（月）</label>
          <input type="number" id="prepayMonth" inputmode="numeric" pattern="[0-9]*" placeholder="例: 1（今月）" min="1" step="1">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="row"><input type="radio" name="mode" value="shorten" checked> 期間短縮型</label>
        <label class="row"><input type="radio" name="mode" value="reduce"> 返済額軽減型</label>
        <span class="pill">単位：金額は「万円」、手数料は「円」</span>
      </div>
      <div class="muted" style="margin-top:6px">元利均等／月利=年利÷12。繰上げは指定月の返済後に反映。</div>
    </section>

    <section class="card">
      <div class="kpis">
        <div class="kpi"><h3>毎月返済額（前）</h3><div class="val" id="kpiMonthly">-</div></div>
        <div class="kpi"><h3>総返済（前）</h3><div class="val" id="kpiTotalBefore">-</div></div>
        <div class="kpi"><h3>総返済（後）</h3><div class="val" id="kpiTotalAfter">-</div><div class="muted" id="kpiAfterNote">方式により異なる</div></div>
        <div class="kpi"><h3>利息削減（手数料後）</h3><div class="val" id="kpiSavings">-</div></div>
        <div class="kpi"><h3>短縮月数／毎月減額</h3><div class="val" id="kpiDelta">-</div><div class="muted" id="kpiDeltaNote">期間短縮＝短縮月数／軽減＝毎月の減額</div></div>
        <div class="kpi"><h3>推奨度</h3><div class="val rating" id="kpiRating">-</div><div class="muted">基準：ROI＝（利息削減−手数料）÷繰上げ額</div></div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">明細（先頭12カ月）</h3>
      <details>
        <summary>表を表示</summary>
        <div id="tableWrap" style="overflow:auto; margin-top:8px"></div>
      </details>
    </section>
  </div>

  <div class="sticky-cta">
    <div class="row">
      <button class="btn primary" id="calcBtn">計算する</button>
      <button class="btn" id="exampleBtn">例を入れる</button>
      <button class="btn" id="resetBtn">リセット</button>
      <span class="muted">設定は端末に保存されます</span>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const yen = (n)=> '¥' + (isFinite(n)? Math.round(n).toLocaleString('ja-JP') : '-');

function monthlyPayment(P, r_m, n){
  if (n <= 0) return 0;
  if (r_m === 0) return P / n;
  const f = Math.pow(1 + r_m, -n);
  return P * r_m / (1 - f);
}
function amortize(P, r_m, n, pay){
  const out = [];
  let bal = P;
  for (let m=1; m<=n; m++){
    const interest = bal * r_m;
    let principal = pay - interest;
    if (principal > bal) principal = bal;
    const payment = interest + principal;
    bal = Math.max(0, bal - principal);
    out.push({month:m, payment, interest, principal, balance:bal});
    if (bal <= 0) break;
  }
  return out;
}
function simulate(params){
  const P = Math.max(0, Number(params.principal)||0) * 10000;
  const annual = Math.max(0, Number(params.annualRate)||0) / 100;
  const n = Math.max(0, Math.round(Number(params.years)||0) * 12);
  const fee = Math.max(0, Number(params.fee)||0);
  const prepay = Math.max(0, Number(params.prepay)||0) * 10000;
  const prepayMonth = Math.min(Math.max(Math.round(Number(params.prepayMonth)||1),1), n);
  const mode = params.mode;
  const r_m = annual / 12;

  // Base
  const pay0 = monthlyPayment(P, r_m, n);
  const base = amortize(P, r_m, n, pay0);
  const total0 = base.reduce((s,x)=>s+x.payment,0);
  const interest0 = base.reduce((s,x)=>s+x.interest,0);

  // Up to prepay month
  const upTo = amortize(P, r_m, n, pay0).slice(0, prepayMonth);
  let balAt = upTo.length ? upTo[upTo.length-1].balance : P;
  let paidToDate = upTo.reduce((s,x)=>s+x.payment,0);

  // Apply prepayment
  const prepayEff = Math.min(prepay, balAt);
  balAt -= prepayEff;

  let afterSched = [];
  let totalAfter = paidToDate + prepayEff;
  let payAfter = pay0;

  if (mode === 'shorten'){
    if (balAt > 0){
      afterSched = amortize(balAt, r_m, n - prepayMonth, pay0);
    }
  } else {
    const remainingTerm = Math.max(0, n - prepayMonth);
    payAfter = monthlyPayment(balAt, r_m, remainingTerm);
    if (balAt > 0 && remainingTerm > 0){
      afterSched = amortize(balAt, r_m, remainingTerm, payAfter);
    }
  }
  totalAfter += afterSched.reduce((s,x)=>s+x.payment,0);
  const interestAfter = (totalAfter - prepayEff) - P;

  const interestSaved = Math.max(0, interest0 - interestAfter);
  const netBenefit = Math.max(0, interestSaved - fee);

  const monthsShort = (mode==='shorten') ? (base.length - (upTo.length + afterSched.length)) : 0;
  const payCut = (mode==='reduce') ? (pay0 - payAfter) : 0;

  // preview rows
  const rows = [];
  const maxRows = 12;
  for (let i=0; i<maxRows; i++){
    const b = base[i] || {month:i+1,payment:0,interest:0,principal:0,balance:0};
    let a;
    if (i < upTo.length){
      a = upTo[i];
    } else if (i === upTo.length){
      a = {month: i+1, payment: (upTo[i]?.payment || 0) + prepayEff, interest: upTo[i]?.interest || 0, principal: (upTo[i]?.principal || 0) + prepayEff, balance: balAt};
    } else {
      const j = i - upTo.length - 1;
      a = afterSched[j] || {month:i+1,payment:0,interest:0,principal:0,balance:0};
    }
    rows.push({b,a});
  }

  return { pay0, total0, totalAfter, interestSaved, netBenefit, monthsShort, payCut, payAfter, rows, prepayEff, mode };
}
function render(){
  const params = {
    principal: $('principal').value,
    annualRate: $('annualRate').value,
    years: $('years').value,
    fee: $('fee').value,
    prepay: $('prepay').value,
    prepayMonth: $('prepayMonth').value,
    mode: document.querySelector('input[name="mode"]:checked').value,
  };
  localStorage.setItem('mpc_v1', JSON.stringify(params));
  const r = simulate(params);

  $('kpiMonthly').textContent = yen(r.pay0);
  $('kpiTotalBefore').textContent = yen(r.total0);
  $('kpiTotalAfter').textContent = yen(r.totalAfter);
  $('kpiAfterNote').textContent = (r.mode==='shorten') ? '期間短縮型（毎月額そのまま）' : '返済額軽減型（毎月額を再計算）';
  $('kpiSavings').textContent = yen(r.netBenefit);

  if (r.mode==='shorten'){
    $('kpiDelta').textContent = r.monthsShort + ' ヵ月 短縮';
    $('kpiDeltaNote').textContent = '完済が前倒しになります';
  } else {
    $('kpiDelta').textContent = yen(r.payCut) + ' /月 減額';
    $('kpiDeltaNote').textContent = '毎月返済額の減少幅（概算）';
  }

  // rating
  let rating = '×（実行非推奨）';
  const roi = (r.prepayEff > 0) ? (r.netBenefit / r.prepayEff) : 0;
  if (r.netBenefit > 0){
    if (roi >= 0.15) rating = '◎（実行強く推奨）';
    else if (roi >= 0.05) rating = '○（推奨）';
    else rating = '△（効果限定的）';
  }
  $('kpiRating').textContent = rating;

  // table
  const html = r.rows.map((row, idx)=>{
    const m = idx+1;
    const b = row.b, a = row.a;
    return `<tr>
      <td>${m}</td><td>繰上げ前</td>
      <td>${yen(b.payment)}</td><td>${yen(b.interest)}</td><td>${yen(b.principal)}</td><td>${yen(b.balance)}</td>
    </tr>
    <tr>
      <td>${m}</td><td>繰上げ後</td>
      <td>${yen(a.payment)}</td><td>${yen(a.interest)}</td><td>${yen(a.principal)}</td><td>${yen(a.balance)}</td>
    </tr>`;
  }).join('');
  $('tableWrap').innerHTML = `<table>
    <thead><tr><th>月</th><th>シナリオ</th><th>返済額</th><th>利息</th><th>元金</th><th>残高</th></tr></thead>
    <tbody>${html}</tbody>
  </table>`;
}

$('calcBtn').addEventListener('click', render);
$('exampleBtn').addEventListener('click', ()=>{
  $('principal').value = 3000;
  $('annualRate').value = 1.0;
  $('years').value = 15;
  $('fee').value = 10000;
  $('prepay').value = 100;
  $('prepayMonth').value = 1;
  document.querySelector('input[name="mode"][value="shorten"]').checked = true;
  render();
});
$('resetBtn').addEventListener('click', ()=>{
  localStorage.removeItem('mpc_v1');
  document.querySelectorAll('input').forEach(el=>{
    if (el.type==='radio') return;
    el.value = '';
  });
  document.querySelector('input[name="mode"][value="shorten"]').checked = true;
  $('kpiMonthly').textContent = $('kpiTotalBefore').textContent = $('kpiTotalAfter').textContent = '−';
  $('kpiSavings').textContent = $('kpiDelta').textContent = '−';
  $('kpiRating').textContent = '-';
  $('tableWrap').innerHTML='';
});

// Load saved
try{
  const saved = JSON.parse(localStorage.getItem('mpc_v1')||'null');
  if (saved){
    $('principal').value = saved.principal ?? '';
    $('annualRate').value = saved.annualRate ?? '';
    $('years').value = saved.years ?? '';
    $('fee').value = saved.fee ?? '';
    $('prepay').value = saved.prepay ?? '';
    $('prepayMonth').value = saved.prepayMonth ?? '';
    const m = saved.mode || 'shorten';
    document.querySelector(`input[name="mode"][value="${m}"]`).checked = true;
    render();
  }
}catch(e){}
</script>
</body>
</html>
